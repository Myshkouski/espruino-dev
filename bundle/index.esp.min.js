"use strict";function t(){throw Error()}function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,{_buffer:[],length:0},t)}function n(t){return t.currentPattern=null,t.arrayOffset=t.patternIndex=t.byteIndex=t.length=0,t.active=!1,t}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setup=t.setup.bind(this),this._read=t.read.bind(this),this._write=t.write.bind(this),this.options={highWaterMark:t.highWaterMark||A},this._busState=new e({watching:[],active:0,nodeIndex:0,configured:!1,ticker:!1})}if("function"!=typeof console.time){var i={};console.time=function(t){i[t]=Date.now()},console.timeEnd=function(t){t in i&&(console.log(t+": "+(Date.now()-i[t]).toFixed(3)+"ms"),delete i[t])}}"function"!=typeof console.error&&(console.error=console.log),[].concat=function(){var t=[];for(var e in this)t.push(this[e]);for(var n in arguments)for(var r in arguments[n])t.push(arguments[n][r]);return t},Promise.race=function(t){if(!(t instanceof Array))throw new TypeError("You must pass an array to Promise.race().");return new this(function(e,n){for(var r,i=0;i<t.length;i++)(r=t[i])&&"function"==typeof r.then?r.then(e,n):e(r)})},t.from=function(t,e,n){var r=[];if("string"==typeof t)for(var i in t)r[i]=t.charCodeAt(i);else(t instanceof Uint8Array||t instanceof Array)&&(r=t);var o=void 0!==e?e:0,u=void 0!==n?n:r.length;return new Uint8Array([].concat([].fill(0,0,o),[].slice.call(r,0),[].fill(0,r.length+o,u)))},t.concat=function(e,n){var r=e||[],i=void 0!==n?n:r.reduce(function(t,e){return t+e.length},0),o=t.from([],0,i);return r.reduce(function(t,e){return o.set(e,t),t+e.length},0),o};var o=!1,u=LED2,c=function(t,e,n){t.write(1),setTimeout(function(){t.write(0),n&&n()},e||20)},s=0,a=0,h=255,f=212,l=64,d=96,g=160,p=function(t){return!(255&-t.reduce(function(t,e){return t+e},0))},v=function(t,e,n){return p(n.slice(5))},b=[[s,a,h,void 0,function(t,e,n){return p(n.slice(-2))},213],function(t){return[[t[3]-1]]},[v,0]],m=[[s,a,h,1,255,void 0,v,0]],w=[new Uint8ClampedArray([s,a,h,0,255,0])],y=[new Uint8ClampedArray([s,a,h,255,0,0])],_=function(t){return new Uint8ClampedArray([s,a,h,255&t.length+1,255&~t.length,f].concat(t,[255&-t.reduce(function(t,e){return t+e},f),0]))};Object.assign=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i in n){var o=n[i];if(o instanceof Object)for(var u in o)t[u]=o[u]}return t};var x=[{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!1,tick:!1}],k=!1,S=function(){for(var t in x){if(x[t].queue.length)if(x[t].immediatePush){for(var e=0;e<x[t].queue.length;e++)x[t].queue[e]();x[t].queue.splice(0)}else for(var n=x[t].queue.splice(0),r=0;r<n.length;r++)n[r]();x[t].tick=k=!1}},I=function(t){return function(e){x[t].queue.push(e),k||x[t].tick||(x[t].tick=k=!0,setTimeout(S))}},E=(I(0),I(1));I(2),e.prototype={push:function(e){if(e.length){var n={chunk:t.from(e),encoding:"binary",next:null};this._buffer.length&&(this._buffer[this._buffer.length-1].next=n),this._buffer.push(n),this.length+=n.chunk.length}return this.length},unshift:function(e){var n={chunk:t.from(e),encoding:"binary",next:null};return this._buffer.length&&(n.next=this._buffer[0]),this._buffer.unshift(n),this.length+=n.chunk.length,this.length},nodes:function(t){var e=this,n=this._buffer.splice(0,t);return n.forEach(function(t){return e.length-=t.chunk.length}),n},at:function(t){if(!(t>=this.length||t<0))for(var e=0;e<this._buffer.length;e++){var n=this._buffer[e].chunk;if(t<n.length)return{index:t,nodeIndex:e,value:n[t]};t-=n.length}},for:function(t,e,n){for(var r=this._buffer[t.nodeIndex],i=t.nodeIndex;i<r.chunk.length;i++)n.call(this,r.chunk[i]);for(var o=1+t.nodeIndex;o<e.nodeIndex;o++)for(var u=this._buffer[o],c=0;c<u.chunk.length;c++)n.call(this,u.chunk[c]);if(t.nodeIndex<e.nodeIndex)for(var s=this._buffer[e.nodeIndex],a=0;a<=e.index;a++)n.call(this,s.chunk[a])},slice:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from([],0,e),i=this._buffer.slice(0,n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var o=this._buffer[n.nodeIndex];r.set(o.chunk.slice(0,e-i),i)}return r},buffer:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from([],0,e),i=this.nodes(n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var o=this.nodes(1)[0];r.set(o.chunk.slice(0,e-i),i),o.chunk=o.chunk.slice(e-i),this.unshift(o.chunk)}return r}};var A=64;r.prototype={setup:function(){return this._busState.configured?Promise.reject("already configured"):(this._busState.configured=!0,this._setup.apply(this,arguments))},parse:function(e){var r=this;this._busState.push(e),this._busState.ticker||(this._busState.ticker=!0,E(function(){r._busState.ticker=!1,function(){var e=this,r=this._busState,i=r.watching,o=(r.frame,r._buffer);if(i.length)for(this._busState.nodeIndex<0&&(this._busState.nodeIndex=0);this._busState.nodeIndex<o.length;this._busState.nodeIndex++)for(var u=o[this._busState.nodeIndex].chunk,c=currentIncomingWatcherIndex=watcherIndex=0,s=isChunkCorrupted=!1;c<u.length;c++){this._busState.active||(this._busState.active=this._busState.watching.reduce(function(n,r){var i=r.patterns;try{return r.currentPattern="function"==typeof i[0]?i[0](t.from([])):i[0],r.active=!0,n+1}catch(t){return e.emit("error",t),n}},0));var a=u[c];for(watcherIndex=0;watcherIndex<i.length;watcherIndex++,s=!1){var h=i[watcherIndex];if(h.active){var f=h.currentPattern[h.byteIndex];if(void 0===f||f===a)s=!0;else if(Array.isArray(f)){if(h.arrayOffset<=0&&f[0]>0&&(h.arrayOffset=f[0]),--h.arrayOffset>0){h.length++;continue}s=!0}else if("function"==typeof f)try{s=!!f.call(this,a,h.length,this._busState.slice(1+h.length))}catch(t){s=!1,this.emit("error",t)}if(s){if(h.length++,++h.byteIndex>=h.currentPattern.length)if(++h.patternIndex>=h.patterns.length){console.time("buffer");var l=this._busState.buffer(h.length);console.timeEnd("buffer"),this._busState.nodeIndex=-1;try{console.time("cb"),h.callback(l,h.pattern),console.timeEnd("cb")}catch(t){this.emit("error",t)}console.time("reset"),i.forEach(n),this._busState.active=0,console.timeEnd("reset")}else{var d=h.patterns[h.patternIndex];h.byteIndex=0;try{h.currentPattern="function"==typeof d?d.call(this,this._busState.slice(h.length)):d}catch(t){n(h),this._busState.active--,this.emit("error",t)}}}else n(h),this._busState.active--,!i.length&&this._busState.length&&this.emit("error",{msg:"Unparsed chunk",data:this._busState.buffer()})}}}else this.emit("error",{msg:"Unexpected watching data",data:this._busState.buffer()})}.call(r)}))},watch:function(t,e){var r=n({patterns:t,callback:e.bind(this)});return this._busState.watching.push(r),r},unwatch:function(t){if(t){var e=this._busState.watching.indexOf(t);e>=0&&this._busState.watching.splice(e,1)}else this._busState.watching.splice(0);return this},rx:function(t,e){var n=this.watch(t,e);return this._read(),n},tx:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"timeout"in n?setTimeout(function(){e._write(t)},n.timeout):this._write(t),this},reset:function(){return this._busState.watching.splice(0),this}};var T=function(e){return{raw:e,code:e[6],body:t.from(e.slice(7,5+e[3]))}},P=function(t){if(1==t.body.length)throw{cmd:t.code,errCode:t.body[0]};return{chunk:t.body.slice(1)}},U={makeTransaction:function(t,e,n){var r=this;return new Promise(function(i,o){r.rx(w,function(){r.rx(e,function(t){return i((n||[T]).reduce(function(t,e){return e(t)},t))})}),r.rx(y,o),r.rx(m,o),r.tx(_(t))}).catch(function(t){throw r.unwatch(),t}).then(function(t){return r.unwatch(),t})},findTargets:function(t,e){if("A"==e)e=0;else{if("B"!=e)throw Error("Unknown ISO14443 type:",e);e=3}return this.makeTransaction([74,t,e],b,[function(t){var e=t.slice(7,5+t[3]),n=e.slice(6,6+e[5]);return{code:t[6],body:e,count:e[0],atqa:e.slice(2,4),sak:e[4],uid:n}}])},authenticate:function(t,e,n){return this.makeTransaction([l,1,d,t].concat([].slice.call(n),[].slice.call(e)),b)},readBlock:function(t){return this.makeTransaction([l,1,48,t],b,[T,P])},writeBlock:function(t,e){return this.makeTransaction([l,1,g,t].concat([].slice.call(e)),b)},readSector:function(t){var e=this;return new Promise(function(n,r){for(var i=[],o=4*t;o<4*t+3;o++)i.push(o);!function(t,n,r){var o=0,u=!1;!function n(c){u||(void 0!==c||o>=t.length?r&&r(c):E(function(){try{!function(t,n,r){e.readBlock(n).then(function(e){i[r]=e,t()}).catch(function(e){console.log("!!!"),t(e)})}(n,t[o],o++)}catch(t){n(t),u=!0}}))}()}(i,0,function(t){return t?r(t):n(i)})})},writeSector:function(t,e){}},B=function(t){return Object.assign(new r(t),U)},D=["","http://www.","https://www.","http://","https://","tel:","mailto:","ftp://anonymous:anonymous@","ftp://ftp.","ftps://","sftp://","smb://","nfs://","ftp://","dav://","news:","telnet://","imap:","rtsp://","urn:","pop:","sip:","sips:","tftp:","btspp://","btl2cap://","btgoep://","tcpobex://","irdaobex://","file://","urn:epc:id:","urn:epc:tag:","urn:epc:pat:","urn:epc:raw:","urn:epc:","urn:nfc:"],L=function(t,e,n,r,i,o,u){return u||(u=o),t&&(u|=128),e&&(u|=64),n&&(u|=32),r&&(u|=16),i&&(u|=8),u},q=!0,O=null;setWatch(function(){(q=!q)?(O=null,USB.removeAllListeners()):((O=new B({setup:function(){USB.on("data",this.parse.bind(this))},read:function(){},write:function(){}})).watch([t.from("/on")],function(){LED1.write(1),USB.write("/on\r\n")}),O.watch([t.from("/off")],function(){LED1.write(0),USB.write("/off\r\n")}),O.on("error",function(t){c(LED1,200)}),O.setup()),q?USB.setConsole(!1):LoopbackA.setConsole(!1)},BTN1,{repeat:!0,edge:"rising",debounce:50}),function(t){t||(t=u),o||(o=!0,c(t,20,function e(){o&&setTimeout(function(){return c(t,20,e)},980)}))}(LED2),function(e){var n=[],r=void 0,i=void 0,o=void 0,u=void 0,c=void 0,s=void 0,a=void 0,h=void 0,f=void 0;for(c=0;c<e.length;c++)s=0===c,a=c===e.length-1,h=e[c].payload.length<255,f=e[c].id.length>0,r=L(s,a,!1,h,f,e[c].tnf),n.push(r),i=[].slice.call(t.from(e[c].type)),n.push(i.length),h?(o=e[c].payload.length,n.push(o)):(o=e[c].payload.length,n.push(o>>24),n.push(o>>16),n.push(o>>8),n.push(255&o)),f&&(u=e[c].id.length,n.push(u)),n=n.concat(i),f&&(n=n.concat(e[c].id)),n=n.concat([].slice.call(e[c].payload))}([function(e,n,r,i,o){return e||(e=0),n||(n=[]),r||(r=[]),i||(i=[]),n instanceof Array&&(n=""+t.from(n)),r instanceof Array||(r=t.from(r)),i instanceof Array||(i=t.from(i)),1==e&&("T"==n?o=function(e){var n=63&e[0];return e.slice(1,1+n),""+t.from(e.slice(n+1))}(i):"U"==n&&(o=function(e){var n=D[e[0]];return n||(n=""),n+""+t.from(e.slice(1))}(i))),{tnf:e,type:n,id:r,payload:i,value:o}}(1,"T",[],function(e,n,r){return n||(n="en"),t.from([n.length].concat([].slice.call(t.from(n+"2enhello world!"))))}(0,void 0))]);var C=_([85]),j=_([20,1,20,0]),W=new B({setup:function(t){Serial1.setup(115200,{rx:B7,tx:B6}),Serial1.write(C),Serial1.write(j),setTimeout(function(){Serial1.read(),Serial1.on("data",function(t){return W.parse(t)}),c(LED1,20,function(){return setTimeout(function(){return c(LED1,20)},200)})},50)},read:function(){},write:function(t){Serial1.write(t)},highWaterMark:64});W.on("error",function(t){console.error("BusError:",t)}),W.setup();var M=new Uint8Array([].fill(255,0,6));setTimeout(function(){!function t(){Promise.resolve().then(function(){return W.findTargets(1,"A")}).then(function(t){return LED1.write(!0),t}).then(function(t){return W.authenticate(4,t.uid,M)}).then(function(t){return W.readSector(1)}).then(function(t){return LED1.write(!1),t}).then(function(t){return t.reduce(function(t,e){return[].concat(t,[].slice.call(e.chunk,0))},[])}).then(console.log).catch(function(t){LED1.write(!1),console.error("Error:",t)}).then(function(){setTimeout(function(){t()},500)})}()},1e3);
//# sourceMappingURL=index.esp.min.js.map
