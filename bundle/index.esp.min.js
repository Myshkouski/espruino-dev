"use strict";function time(t){timers[t]=Date.now()}function timeEnd(t){t in timers&&(console.log(t+": "+(Date.now()-timers[t]).toFixed(3)+"ms"),delete timers[t])}function Buffer(){throw new Error("Buffer constructor is deprecated. Use Buffer.from() instead.")}function BufferState(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,{_buffer:[],length:0},t)}function series(t,e,n){var r=0;!function i(_){void 0!==_||r>=t.length?n&&n(_):setImmediate(function(){return e(i,t[r],r++,t)})}()}function _parse(t){var e=this._busState,n=e.incoming,r=e.watching,i=e.frame,_=0,o=0,s=!1;if(r.length)for(;_<t.length;_++){if(i.push(t[_]),!n.length)for(var u in r)try{n.push({patterns:r[u].patterns,callback:r[u].callback,currentPattern:r[u].patterns[0]instanceof Function?r[u].patterns[0]([]):r[u].patterns[0],arrayOffset:0,patternIndex:0,byteIndex:0,length:0})}catch(t){this.emit("error",t)}for(o=0;o<n.length;){var c=n[o],a=c.currentPattern[c.byteIndex];if(void 0===a||a===t[_])s=!0,c.byteIndex++;else if(a instanceof Array){if(s=!0,c.arrayOffset<=0&&a[0]>0&&(c.arrayOffset=a[0]),--c.arrayOffset>0)continue;c.byteIndex++}else if(a instanceof Function)try{s=!!a.call(this,t[_],c.length,i.slice(-c.length-1)),c.byteIndex++}catch(t){this.emit("error",t),s=!1}else s=!1;if(s)if(c.length++,c.byteIndex>=c.currentPattern.length)if(++c.patternIndex>=c.patterns.length){try{c.callback.call(this,i.splice(-c.length),c.pattern)}catch(t){this.emit("error",t)}n.splice(0)}else{var N=c.patterns[c.patternIndex];c.byteIndex=0;try{N instanceof Function?c.currentPattern=N(i.slice(-c.length)):c.currentPattern=N,o++}catch(t){this.emit("error",t),n.splice(o,1)}}else o++;else n.splice(o,1)}!n.length&&i.length&&this.emit("error",{msg:"Unparsed chunk",data:i.splice(0)})}else this.emit("error",new Error({msg:"Unexpected incoming data",data:t}))}function _Bus(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setup=t.setup.bind(this),this.options={highWaterMark:t.highWaterMark||64},this._busState=new BufferState({watching:[],incoming:[],frame:[],configured:!1})}function _Schedule(){this.pending=Promise.resolve(null)}function blink(t){return void 0===t&&(t=!status),t?blink.start():blink.stop(),!!status}function rx(t){var e=this;this._busState.push(t),this._busState.nodes().forEach(function(t){return e.parse(t.chunk)})}function setup(t){var e=this;Serial1.setup(115200,{rx:B7,tx:B6}),Serial1.write(wakeup),Serial1.write(sam),setTimeout(function(){Serial1.read(),Serial1.on("data",rx.bind(e))},1500),setTimeout(function(){blink.once(LED1,20,function(){return setTimeout(function(){return blink.once(LED1,20)},200)}),t()},2e3)}var timers={};"function"!=typeof console.time&&(console.time=time,console.timeEnd=timeEnd),"function"!=typeof console.error&&(console.error=console.log),Array.prototype.concat=function(){var t=[];for(var e in this)t.push(this[e]);for(var n in arguments)for(var r in arguments[n])t.push(arguments[n][r]);return t},Promise.race=function(t){var e=this;if(!(t instanceof Array))throw new TypeError("You must pass an array to Promise.race().");return new e(function(e,n){for(var r,i=0;i<t.length;i++)(r=t[i])&&"function"==typeof r.then?r.then(e,n):e(r)})},Buffer.from=function(){var t=[];if("string"==typeof arguments[0]){for(var e in arguments[0])t[e]=arguments[0].charCodeAt(e);t=new Uint8Array(t)}else(arguments[0]instanceof Uint8Array||arguments[0]instanceof Array)&&(t=new Uint8Array(arguments[0]));for(var n=void 0!==arguments[1]?arguments[1]:0,r=void 0!==arguments[2]?arguments[2]:t.length,i=[],_=n;_--;)i[_]=0;for(var o=0;o<t.length&&o<r;o++)i[n+o]=t[o];for(var s=i.length;s<r;s++)i[s]=0;return new Uint8Array(i)},Buffer.concat=function(){var t=arguments[0]||[],e=void 0!==arguments[1]?arguments[1]:t.reduce(function(t,e){return t+e.length},0),n=Buffer.from([],0,e),r=0;return t.forEach(function(t){n.set(t,r),r+=t.length}),n},Object.assign=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i in n){var _=n[i];if(_ instanceof Object)for(var o in _)t[o]=_[o]}return t},BufferState.prototype={push:function(t){var e={chunk:Buffer.from(t),next:null};return this._buffer.length&&(this._buffer[this._buffer.length-1].next=e),this._buffer.push(e),this.length+=e.chunk.length,this.length},unshift:function(t){var e={chunk:Buffer.from(t),encoding:"binary",next:null};return this._buffer.length&&(e.next=this._buffer[0]),this._buffer.unshift(e),this.length+=e.chunk.length,this.length},nodes:function(t){var e=this,n=this._buffer.splice(0,t);return n.forEach(function(t){return e.length-=t.chunk.length}),n},at:function(t){if(!(t>=this.length||t<0))for(var e=0;e<this._buffer.length;e++){if(t<this._buffer[e].chunk.length)return{index:t,nodeIndex:e};t-=this._buffer[e].chunk.length}},buffer:function(t){if(void 0===t&&(t=this.length),!this.length)return Buffer.from([]);t>this.length&&(t=this.length);var e=void 0;t&&(e=this.at(t)),e||(e={index:this.length-1,nodeIndex:this._buffer.length-1});var n=Buffer.from([],0,t),r=this.nodes(e.nodeIndex).reduce(function(t,e){return n.set(e.chunk,t),t+=e.chunk.length},0);if(r<t){var i=this.nodes(1).shift();n.set(i.chunk.slice(0,t-r),r),i.chunk=i.chunk.slice(t-r),this.unshift(i)}return n}};var loop=[{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!1,tick:!1}],tick=!1,asyncFlush=function(){for(var t in loop){if(loop[t].queue.length)if(loop[t].immediatePush){for(var e=0;e<loop[t].queue.length;e++)loop[t].queue[e]();loop[t].queue.splice(0)}else for(var n=loop[t].queue.splice(0),r=0;r<n.length;r++)n[r]();loop[t].tick=tick=!1}},asyncCall=function(t){return function(e){loop[t].queue.push(e),tick||loop[t].tick||(loop[t].tick=tick=!0,setTimeout(asyncFlush))}},nextTick=asyncCall(0),setImmediate=asyncCall(1),timeoutCall=asyncCall(2);_Bus.prototype={setup:function(){return this._busState.configured?Promise.reject("already configured"):(this._busState.configured=!0,this._setup.apply(this,arguments))},parse:function(t){var e=this,n=this.options.highWaterMark;if(t.length>n){for(var r=[],i=t.length,_=0;i>0;i-=n){var o=t.slice(_,_+=n);r.push(o)}series(r,function(t,n){_parse.call(e,n),t()})}else _parse.apply(this,arguments)},watch:function(t,e){var n={patterns:t,callback:e};return this._busState.watching.push(n),n},unwatch:function(t){if(t){var e=this._busState.watching.indexOf(t);e>=0&&this._busState.watching.splice(e,1)}else this._busState.watching.splice(0);return this},rx:function(t,e){var n=this,r=this.watch(t,function(t){var i=n._busState.watching.indexOf(r);i>=0&&n._busState.watching.splice(0,i+1),e(t)});return this},tx:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return console.log("tx"),"timeout"in n?new Promise(function(r,i){setTimeout(function(){e.write(t),r()},n.timeout)}):(this.write(t),Promise.resolve())},reset:function(){return this._busState.frame.splice(0),this._busState.incoming.splice(0),this}},_Schedule.prototype={immediate:function(t){var e=this;return this.pending=Promise.all([this.pending,new Promise(function(e,n){t(e,n)}).catch(function(t){return e.emit("error",t)})]),this},deferred:function(t){var e=this;return this.pending=this.pending.then(function(e){return new Promise(function(e,n){t(e,n)})}).catch(function(t){return e.emit("error",t)}),this}};var status=!1;blink.start=function(){status||(status=!0,blink.once(LED2,20,function t(){status&&setTimeout(function(){return blink.once(LED2,20,t)},980)}))},blink.stop=function(){status&&(status=!1)},blink.once=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,n=arguments[2];t.write(!0),setTimeout(function(){t.write(!1),n&&n()},e)};var data={PN532_PREAMBLE:0,PN532_STARTCODE1:0,PN532_STARTCODE2:255,PN532_POSTAMBLE:0,PN532_HOST_TO_PN532:212,PN532_PN532_TO_HOST:213,PN532_COMMAND_DIAGNOSE:0,PN532_COMMAND_GETFIRMWAREVERSION:2,PN532_COMMAND_GETGENERALSTATUS:4,PN532_COMMAND_READREGISTER:6,PN532_COMMAND_WRITEREGISTER:8,PN532_COMMAND_READGPIO:12,PN532_COMMAND_WRITEGPIO:14,PN532_COMMAND_SETSERIALBAUDRATE:16,PN532_COMMAND_SETPARAMETERS:18,PN532_COMMAND_SAMCONFIGURATION:20,PN532_COMMAND_POWERDOWN:22,PN532_COMMAND_RFCONFIGURATION:50,PN532_COMMAND_RFREGULATIONTEST:88,PN532_COMMAND_INJUMPFORDEP:86,PN532_COMMAND_INJUMPFORPSL:70,PN532_COMMAND_INLISTPASSIVETARGET:74,PN532_COMMAND_INATR:80,PN532_COMMAND_INPSL:78,PN532_COMMAND_INDATAEXCHANGE:64,PN532_COMMAND_INCOMMUNICATETHRU:66,PN532_COMMAND_INDESELECT:68,PN532_COMMAND_INRELEASE:82,PN532_COMMAND_INSELECT:84,PN532_COMMAND_INAUTOPOLL:96,PN532_COMMAND_TGINITASTARGET:140,PN532_COMMAND_TGSETGENERALBYTES:146,PN532_COMMAND_TGGETDATA:134,PN532_COMMAND_TGSETDATA:142,PN532_COMMAND_TGSETMETADATA:148,PN532_COMMAND_TGGETINITIATORCOMMAND:136,PN532_COMMAND_TGRESPONSETOINITIATOR:144,PN532_COMMAND_TGGETTARGETSTATUS:138,PN532_WAKEUP:85,PN532_SPI_STATREAD:2,PN532_SPI_DATAWRITE:1,PN532_SPI_DATAREAD:3,PN532_SPI_READY:1,PN532_I2C_ADDRESS:36,PN532_I2C_READBIT:1,PN532_I2C_BUSY:0,PN532_I2C_READY:1,PN532_I2C_READYTIMEOUT:20,PN532_MIFARE_ISO14443A:0,MIFARE_CMD_AUTH_A:96,MIFARE_CMD_AUTH_B:97,MIFARE_CMD_READ_16:48,MIFARE_CMD_WRITE_4:162,MIFARE_CMD_WRITE_16:160,MIFARE_CMD_TRANSFER:176,MIFARE_CMD_DECREMENT:192,MIFARE_CMD_INCREMENT:193,MIFARE_CMD_RESTORE:194,NDEF_URIPREFIX_NONE:0,NDEF_URIPREFIX_HTTP_WWWDOT:1,NDEF_URIPREFIX_HTTPS_WWWDOT:2,NDEF_URIPREFIX_HTTP:3,NDEF_URIPREFIX_HTTPS:4,NDEF_URIPREFIX_TEL:5,NDEF_URIPREFIX_MAILTO:6,NDEF_URIPREFIX_FTP_ANONAT:7,NDEF_URIPREFIX_FTP_FTPDOT:8,NDEF_URIPREFIX_FTPS:9,NDEF_URIPREFIX_SFTP:10,NDEF_URIPREFIX_SMB:11,NDEF_URIPREFIX_NFS:12,NDEF_URIPREFIX_FTP:13,NDEF_URIPREFIX_DAV:14,NDEF_URIPREFIX_NEWS:15,NDEF_URIPREFIX_TELNET:16,NDEF_URIPREFIX_IMAP:17,NDEF_URIPREFIX_RTSP:18,NDEF_URIPREFIX_URN:19,NDEF_URIPREFIX_POP:20,NDEF_URIPREFIX_SIP:21,NDEF_URIPREFIX_SIPS:22,NDEF_URIPREFIX_TFTP:23,NDEF_URIPREFIX_BTSPP:24,NDEF_URIPREFIX_BTL2CAP:25,NDEF_URIPREFIX_BTGOEP:26,NDEF_URIPREFIX_TCPOBEX:27,NDEF_URIPREFIX_IRDAOBEX:28,NDEF_URIPREFIX_FILE:29,NDEF_URIPREFIX_URN_EPC_ID:30,NDEF_URIPREFIX_URN_EPC_TAG:31,NDEF_URIPREFIX_URN_EPC_PAT:32,NDEF_URIPREFIX_URN_EPC_RAW:33,NDEF_URIPREFIX_URN_EPC:34,NDEF_URIPREFIX_URN_NFC:35,PN532_GPIO_VALIDATIONBIT:128,PN532_GPIO_P30:0,PN532_GPIO_P31:1,PN532_GPIO_P32:2,PN532_GPIO_P33:3,PN532_GPIO_P34:4,PN532_GPIO_P35:5,PN532_SAM_NORMAL_MODE:1,PN532_SAM_VIRTUAL_CARD:2,PN532_SAM_WIRED_CARD:3,PN532_SAM_DUAL_CARD:4,PN532_BRTY_ISO14443A:0,PN532_BRTY_ISO14443B:3,PN532_BRTY_212KBPS:1,PN532_BRTY_424KBPS:2,PN532_BRTY_JEWEL:4,NFC_WAIT_TIME:30,NFC_CMD_BUF_LEN:64,NFC_FRAME_ID_INDEX:6},PN532_PREAMBLE=data.PN532_PREAMBLE,PN532_STARTCODE1=data.PN532_STARTCODE1,PN532_STARTCODE2=data.PN532_STARTCODE2,PN532_POSTAMBLE=data.PN532_POSTAMBLE,PN532_HOST_TO_PN532=data.PN532_HOST_TO_PN532,PN532_PN532_TO_HOST=data.PN532_PN532_TO_HOST,PN532_COMMAND_SAMCONFIGURATION=data.PN532_COMMAND_SAMCONFIGURATION,PN532_COMMAND_INLISTPASSIVETARGET=data.PN532_COMMAND_INLISTPASSIVETARGET,PN532_COMMAND_INDATAEXCHANGE=data.PN532_COMMAND_INDATAEXCHANGE,PN532_WAKEUP=data.PN532_WAKEUP,MIFARE_CMD_AUTH_A=data.MIFARE_CMD_AUTH_A,MIFARE_CMD_READ_16=data.MIFARE_CMD_READ_16,PN532_SAM_NORMAL_MODE=data.PN532_SAM_NORMAL_MODE,check=function(t){return!(255&-t.reduce(function(t,e){return t+e},0))},LCS_std=function(t,e,n){return check(n.slice(-2))},CHECKSUM_std=function(t,e,n){return check(n.slice(5))},BODY_std=function(t){for(var e=[],n=0;n<t[3]-1;n++)e.push(void 0);return e},info=[[PN532_PREAMBLE,PN532_STARTCODE1,PN532_STARTCODE2,void 0,LCS_std,PN532_PN532_TO_HOST],BODY_std,[CHECKSUM_std,PN532_POSTAMBLE]],err=[[PN532_PREAMBLE,PN532_STARTCODE1,PN532_STARTCODE2,1,255,void 0,CHECKSUM_std,PN532_POSTAMBLE]],ack=[new Uint8ClampedArray([PN532_PREAMBLE,PN532_STARTCODE1,PN532_STARTCODE2,0,255,PN532_POSTAMBLE])],command=function(t){return new Uint8ClampedArray([PN532_PREAMBLE,PN532_STARTCODE1,PN532_STARTCODE2,255&t.length+1,255&~t.length,PN532_HOST_TO_PN532].concat(t,[255&-t.reduce(function(t,e){return t+e},PN532_HOST_TO_PN532),PN532_POSTAMBLE]))},data$2={TNF_EMPTY:0,TNF_WELL_KNOWN:1,TNF_MIME_MEDIA:2,TNF_ABSOLUTE_URI:3,TNF_EXTERNAL_TYPE:4,TNF_UNKNOWN:5,TNF_UNCHANGED:6,TNF_RESERVED:7,RTD_TEXT:"T",RTD_URI:"U",RTD_SMART_POSTER:"Sp",RTD_ALTERNATIVE_CARRIER:"ac",RTD_HANDOVER_CARRIER:"Hc",RTD_HANDOVER_REQUEST:"Hr",RTD_HANDOVER_SELECT:"Hs",BLOCK_SIZE:16,TLV_START:64,TL_LENGTH:4},decode=function(t){var e=63&t[0];t.slice(1,1+e);return Buffer.from(t.slice(e+1)).toString()},encode=function(t,e,n){return e||(e="en"),Buffer.from([e.length].concat([].slice.call(Buffer.from(e+t))))},protocols=["","http://www.","https://www.","http://","https://","tel:","mailto:","ftp://anonymous:anonymous@","ftp://ftp.","ftps://","sftp://","smb://","nfs://","ftp://","dav://","news:","telnet://","imap:","rtsp://","urn:","pop:","sip:","sips:","tftp:","btspp://","btl2cap://","btgoep://","tcpobex://","irdaobex://","file://","urn:epc:id:","urn:epc:tag:","urn:epc:pat:","urn:epc:raw:","urn:epc:","urn:nfc:"],decode$1=function(t){var e=protocols[t[0]];return e||(e=""),e+Buffer.from(t.slice(1)).toString()},record=function(t,e,n,r,i){return t||(t=data$2.TNF_EMPTY),e||(e=[]),n||(n=[]),r||(r=[]),e instanceof Array&&(e=Buffer.from(e).toString()),n instanceof Array||(n=Buffer.from(n)),r instanceof Array||(r=Buffer.from(r)),t==data$2.TNF_WELL_KNOWN&&(e==data$2.RTD_TEXT?i=decode(r):e==data$2.RTD_URI&&(i=decode$1(r))),{tnf:t,type:e,id:n,payload:r,value:i}},textRecord=function(t,e,n){return record(data$2.TNF_WELL_KNOWN,data$2.RTD_TEXT,n||[],encode(t,e))},encodeMessage=function(t){var e=[],n=void 0,r=void 0,i=void 0,_=void 0,o=void 0,s=void 0,u=void 0,c=void 0,a=void 0;for(o=0;o<t.length;o++)s=0===o,u=o===t.length-1,c=t[o].payload.length<255,a=t[o].id.length>0,n=encodeTnf(s,u,!1,c,a,t[o].tnf),e.push(n),r=[].slice.call(Buffer.from(t[o].type)),e.push(r.length),c?(i=t[o].payload.length,e.push(i)):(i=t[o].payload.length,e.push(i>>24),e.push(i>>16),e.push(i>>8),e.push(255&i)),a&&(_=t[o].id.length,e.push(_)),e=e.concat(r),a&&(e=e.concat(t[o].id)),e=e.concat([].slice.call(t[o].payload));return e},encodeTnf=function(t,e,n,r,i,_,o){return o||(o=_),t&&(o|=128),e&&(o|=64),n&&(o|=32),r&&(o|=16),i&&(o|=8),o};blink();var encoded=encodeMessage([textRecord("2enhello world!")]),wakeup=command([PN532_WAKEUP]),sam=command([PN532_COMMAND_SAMCONFIGURATION,PN532_SAM_NORMAL_MODE,20,0]),bus=new _Bus({setup:setup,highWaterMark:64}),schedule=new _Schedule;bus.on("error",console.error),schedule.deferred(setup.bind(bus));var readBlock=function(t,e,n){var r=function(r,i){"compiled";var _=command([PN532_COMMAND_INDATAEXCHANGE,1,MIFARE_CMD_AUTH_A,n].concat(e,t));bus.rx(ack,function(t){}),bus.rx(err,function(t){console.error(t),i(t)}),bus.rx(info,function(t){console.log("AUTH SUCCEED",{code:t[6],body:t.slice(7,-2)}),r()}),Serial1.write(_)},i=function(t,e){console.log("read");var r=command([PN532_COMMAND_INDATAEXCHANGE,1,MIFARE_CMD_READ_16,n]);bus.rx(ack,function(t){}),bus.rx(err,function(t){console.error(t),e(t)}),bus.rx(info,function(e){var r=e.slice(8,-2),i={block:n,status:e[7],body:r,length:r.length};t(i)}),Serial1.write(r)};return Promise.resolve().then(function(){return new Promise(r)}).then(function(){return new Promise(i)})},readSector=function(t,e,n){return new Promise(function(r,i){for(var _=[],o=4*n;o<4*n+4;o++)_.push(o);series(_,function(n,r,i){readBlock(t,e,r).then(function(t){_[i]=t,n()})},function(){return r(_)})})},key=new Uint8ClampedArray([255,255,255,255,255,255]);!function t(){var e=void 0;schedule.deferred(function(t){var n=command([PN532_COMMAND_INLISTPASSIVETARGET,1,0]);bus.rx(ack,function(){console.log("ACK")}),bus.rx(info,function(n){var r=n.slice(7,5+n[3]),i=r[5],_=r.slice(6,6+i);console.log("FOUND",[n[6],r[0],r.slice(2,4),r[4]][2]),e=_,t()}),Serial1.write(n)}),schedule.deferred(function(t,n){readSector(e,key,0).then(function(t){return console.log(t),t}).then(t).catch(console.error)}),schedule.deferred(function(e){setTimeout(function(){console.log(process.memory().free),e(),t()},1e3)})}();
//# sourceMappingURL=index.esp.min.js.map
