"use strict";function t(){throw Error()}function e(){this._listeners={}}function n(t){t&&("#"+t in this?this._listeners[t]=this["#"+t]:delete this._listeners[t])}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,{_buffer:[],length:0},t)}function i(){--this._busState.active||this.emit("inactive")}function o(t){return t.currentPattern=null,t.arrayOffset=t.patternIndex=t.byteIndex=t.length=0,t.active=!1,t}function u(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.transport=e.transport,this.type=e.type,this._setup=e.setup.bind(this),this._read=function(n){return e.read.call(t,void 0===n?n:t.options.highWaterMark)},this._write=e.write.bind(this),this.options={highWaterMark:e.highWaterMark||B},this._busState=new r({watching:[],active:0,nodeIndex:0,configured:!1,ticker:!1})}if("function"!=typeof console.time){var a={};console.time=function(t){a[t]=Date.now()},console.timeEnd=function(t){t in a&&(console.log(t+": "+(Date.now()-a[t]).toFixed(3)+"ms"),delete a[t])}}"function"!=typeof console.error&&(console.error=console.log);var s=1,c=0;process.env.CHIP&&"ESP32"==process.env.CHIP.toUpperCase()&&(s=0,c=1);var f=function(t,e,n){t.write(s),setTimeout(function(){t.write(c),n&&n()},e||20)},h=0,l=0,d=255,p=212,g=64,v=96,y=160,b=function(t){return!(255&-t.reduce(function(t,e){return t+e},0))},m=function(t){var e=t.getFrame,n=t.getAbsoluteIndex;return b(e().slice(n(5)))},_=[[h,l,d,void 0,function(t){var e=t.getFrame;return b(e().slice(-2))},213,function(t){var e=t.getFrame,n=t.getAbsoluteIndex;return[e()[n(3)]-1]},m,0]],x=[[h,l,d,1,255,void 0,m,0]],w=[new Uint8ClampedArray([h,l,d,0,255,0])],k=[new Uint8ClampedArray([h,l,d,255,0,0])],I=function(t){return new Uint8Array([h,l,d,255&t.length+1,255&~t.length,p].concat(t,[255&-t.reduce(function(t,e){return t+e},p),0]))};Object.assign=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i in n){var o=n[i];if(o instanceof Object)for(var u in o)t[u]=o[u]}return t},[].concat=function(){var t=[];for(var e in this)t.push(this[e]);for(var n in arguments)for(var r in arguments[n])t.push(arguments[n][r]);return t},Promise.race=function(t){if(!(t instanceof Array))throw new TypeError("You must pass an array to Promise.race().");return new this(function(e,n){for(var r,i=0;i<t.length;i++)(r=t[i])&&"function"==typeof r.then?r.then(e,n):e(r)})};var S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};t.from=function(t,e,n){if("string"==typeof t){var r=[];for(var i in t)r[i]=t.charCodeAt(i);return new Uint8Array(r)}if(t instanceof ArrayBuffer)return new Uint8Array(t.slice(void 0!==e?e:0,e+(void 0!==n?n:t.length)));if(t instanceof Array||t instanceof Uint8Array)return new Uint8Array(t);throw new TypeError("Cannot create buffer from",void 0===t?"undefined":S(t))},t.concat=function(e,n){var r=e||[],i=void 0!==n?n:r.reduce(function(t,e){return t+e.length},0),o=t.from([],0,i);return r.reduce(function(t,e){return o.set(e,t),t+e.length},0),o};var P="_super",A="_apply",E="_isExtended",T=function(t,e,n,r){t.prototype[n]||Object.defineProperty(t.prototype,n,{value:[]}),e.forEach(function(e){var i=!!e.prototype[E],o=!!e.prototype[n],u=t.prototype[n].some(function(t){return t===e}),a=!(i&&r||u);i&&o&&e.prototype[n].forEach(function(e){t.prototype[n].some(function(t){return t===e})||t.prototype[n].push(e)}),a&&t.prototype[n].push(e)})},O=[{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!1,tick:!1}],U=!1,j=function(){for(var t in O){if(O[t].queue.length)if(O[t].immediatePush){for(var e=0;e<O[t].queue.length;e++)O[t].queue[e]();O[t].queue.splice(0)}else for(var n=O[t].queue.splice(0),r=0;r<n.length;r++)n[r]();O[t].tick=U=!1}},q=function(t){return function(e){O[t].queue.push(e),U||O[t].tick||(O[t].tick=U=!0,setTimeout(j))}},C=(q(0),q(1));q(2),e.prototype={on:function(t,e){return{}.on.call(this,t,e),n.call(this,t),this},removeListener:function(t,e){return{}.on.call(this,t,e),n.call(this,t),this},once:function(t,e){return this.on(t,function(){return this.removeListener(t,_listener),e.apply(this,arguments)})}},r.prototype={push:function(e){if(e.length){var n={chunk:t.from(e),encoding:"binary",next:null};this._buffer.length&&(this._buffer[this._buffer.length-1].next=n),this._buffer.push(n),this.length+=n.chunk.length}return this.length},unshift:function(e){var n={chunk:t.from(e),encoding:"binary",next:null};return this._buffer.length&&(n.next=this._buffer[0]),this._buffer.unshift(n),this.length+=n.chunk.length,this.length},nodes:function(t){var e=this,n=this._buffer.splice(0,t);return n.forEach(function(t){return e.length-=t.chunk.length}),n},at:function(t){if(!(t>=this.length||t<0))for(var e=0;e<this._buffer.length;e++){var n=this._buffer[e].chunk;if(t<n.length)return{index:t,nodeIndex:e,value:n[t]};t-=n.length}},for:function(t,e,n){for(var r=this._buffer[t.nodeIndex],i=t.nodeIndex;i<r.chunk.length;i++)n.call(this,r.chunk[i]);for(var o=1+t.nodeIndex;o<e.nodeIndex;o++)for(var u=this._buffer[o],a=0;a<u.chunk.length;a++)n.call(this,u.chunk[a]);if(t.nodeIndex<e.nodeIndex)for(var s=this._buffer[e.nodeIndex],c=0;c<=e.index;c++)n.call(this,s.chunk[c])},slice:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from(Array(e)),i=this._buffer.slice(0,n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var o=this._buffer[n.nodeIndex];r.set(o.chunk.slice(0,e-i),i)}return r},buffer:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from(Array(e)),i=this.nodes(1+n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var o=this.nodes(1)[0];r.set(o.chunk.slice(0,e-i),i),o.chunk=o.chunk.slice(e-i),this.unshift(o.chunk)}return r}};var B=64;u.prototype={setup:function(){return this._busState.configured?Promise.reject("already configured"):(this._busState.configured=!0,this._setup.apply(this,arguments))},push:function(e){var n=this;e.length&&(this._busState.push(e),this._busState.ticker||(this._busState.ticker=!0,C(function(){n._busState.ticker=!1,function(){var e=this,n=this._busState,r=n.watching,u=(n.frame,n._buffer);if(r.length){for(this._busState.nodeIndex<0&&(this._busState.nodeIndex=0);this._busState.nodeIndex<u.length;this._busState.nodeIndex++)for(var a=u[this._busState.nodeIndex].chunk,s=0,c=0,f=!1;s<a.length;s++){this._busState.active||(this._busState.active=this._busState.watching.reduce(function(n,r){var i=r.patterns;try{return r.currentPattern="function"==typeof i[0]?i[0](t.from([])):i[0],r.active=!0,n+1}catch(t){return e.emit("error",t),n}},0));var h=a[s],l=function(){var t=r[c];if(!t.active)return"continue";var n=t.currentPattern[t.byteIndex];if(void 0===n||n===h)f=!0;else if(Array.isArray(n)){if(t.arrayOffset<=0&&n[0]>0&&(t.arrayOffset=n[0]),--t.arrayOffset>0)return t.length++,"continue";f=!0}else if("function"==typeof n)try{f=!!n.call(e,{byte:h,index:t.byteIndex,getRelativeIndex:function(e){if("number"!=typeof e)throw TypeError("number");if((e+=t.byteIndex)<0||e>t.currentPattern.length)throw ReferenceError("Illegal pattern boundaries");return e+t.length-t.byteIndex},getAbsoluteIndex:function(e){if("number"!=typeof e)throw TypeError("number");if(e<0&&(e+=t.currentPattern.length),e<0||e>t.currentPattern.length)throw ReferenceError("Illegal pattern boundaries");return e+t.length-t.byteIndex},getFrame:function(){return e._busState.slice(1+t.length)}})}catch(t){f=!1,e.emit("error",t)}if(f){if(t.length++,++t.byteIndex>=t.currentPattern.length)if(++t.patternIndex>=t.patterns.length){var u=e._busState.buffer(t.length);e._busState.nodeIndex=-1;try{t.callback(u,t.pattern)}catch(t){e.emit("error",t)}r.forEach(function(t){o(t),i.call(e)})}else{var a=t.patterns[t.patternIndex];t.byteIndex=0;try{t.currentPattern="function"==typeof a?a.call(e,e._busState.slice(t.length)):a}catch(n){o(t),i.call(e),e.emit("error",n)}}}else console.log(t),o(t),i.call(e),e._busState.active||e.emit("error",{msg:"Unparsed chunk",data:e._busState.buffer()})};for(c=0;c<r.length;c++,f=!1)l()}this._busState.active&&this.emit("drain")}else this.emit("error",{msg:"Unexpected watching data",data:this._busState.buffer()})}.call(n)})))},watch:function(t,e){var n=o({patterns:t,callback:e.bind(this)});return this._busState.watching.push(n),n},unwatch:function(t){if(t){var e=this._busState.watching.indexOf(t);e>=0&&this._busState.watching.splice(e,1)}else this._busState.watching.splice(0);return this},rx:function(t){var e=this,n=void 0,r={};if("function"==typeof(arguments.length<=1?void 0:arguments[1]))n=arguments.length<=1?void 0:arguments[1];else{if("function"!=typeof(arguments.length<=2?void 0:arguments[2]))throw new ReferenceError("Callback is not provided");n=arguments.length<=2?void 0:arguments[2],Object.assign(r,arguments.length<=1?void 0:arguments[1])}var i=void 0,o=function(){i=e.watch(t,n),e._read(e.options.highWaterMark)};return"timeout"in r?setTimeout(o,r.timeout):o(),i},tx:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"timeout"in n?setTimeout(function(){e._write(t)},n.timeout):this._write(t),this},reset:function(){return this._busState.watching.splice(0),this}};var F=function(){function t(){var e=this,n=arguments;t.prototype[A].forEach(function(r){r!==t&&r.apply(e,n)})}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.apply||(e.apply=[]),e.super||(e.super=[]),e.static||(e.static=[]);var n=e.super[0];e.name||(e.name=n.name),function(t,e,n){try{Object.defineProperty(t,"name",n)}catch(e){return n.get?t.value=n.get():n.value&&(t.name=n.value),t}}(t,0,{value:e.name});for(var r in e.static)for(var i in e.static[r])"prototype"!=i&&Object.defineProperty(t,i,{value:proto[i],enumerable:!0,writable:!0});(t.prototype={}).constructor=n,t.prototype[E]=!0;for(var o in e.super){var u=function(){};u.prototype=e.super[o].prototype;var a=new u;for(var s in a)["constructor",E,P,A].indexOf(s)<0&&Object.defineProperty(t.prototype,s,{value:a[s],enumerable:!0,writable:!0})}return T(t,e.super,P,!1),T(t,e.apply,A,!0),t}({super:[u,e],apply:[u,e]}),M=function(e){return{raw:e,code:e[6],body:t.from(e.slice(7,5+e[3]))}},W=function(t){if(1==t.body.length)throw{cmd:t.code,errCode:t.body[0]};return{chunk:t.body.slice(1)}},D={makeTransaction:function(t,e,n){var r=this;return new Promise(function(i,o){r.rx(w,function(){r.rx(e,function(t){return i((n||[M]).reduce(function(t,e){return e(t)},t))})}),r.rx(k,o),r.rx(x,o),r.tx(I(t))}).catch(function(t){throw r.unwatch(),t}).then(function(t){return r.unwatch(),t})},findTargets:function(t,e){if("A"==e)e=0;else{if("B"!=e)throw Error("Unknown ISO14443 type:",e);e=3}return this.makeTransaction([74,t,e],_,[function(t){var e=t.slice(7,5+t[3]),n=e.slice(6,6+e[5]);return{code:t[6],body:e,count:e[0],atqa:e.slice(2,4),sak:e[4],uid:n}}])},authenticate:function(t,e,n){return this.makeTransaction([g,1,v,t].concat([].slice.call(n),[].slice.call(e)),_)},readBlock:function(t){return this.makeTransaction([g,1,48,t],_,[M,W])},writeBlock:function(t,e){return this.makeTransaction([g,1,y,t].concat([].slice.call(e)),_)},readSector:function(t){var e=this;return new Promise(function(n,r){for(var i=[],o=4*t;o<4*t+3;o++)i.push(o);!function(t,n,r){var o=0,u=!1;!function n(a){u||(void 0!==a||o>=t.length?r&&r(a):C(function(){try{!function(t,n,r){e.readBlock(n).then(function(e){i[r]=e,t()}).catch(function(e){console.log("!!!"),t(e)})}(n,t[o],o++)}catch(t){n(t),u=!0}}))}()}(i,0,function(t){return t?r(t):n(i)})})},writeSector:function(t,e){}},L=I([85]),R=I([20,1,20,0]),H=new function(t){return Object.assign(new F(t),D)}({transport:Serial1,type:"serial",setup:function(){var t=this;if("serial"==this.type)this.transport.setup(115200),this.transport.write(L),this.transport.write(R),setTimeout(function(){t.transport.read(),t.transport.on("data",function(e){return t.push(e)}),console.log("Bus has been set up"),f(LED1,20,function(){setTimeout(function(){return f(LED1,20)},200)}),t.rx([].concat(w,_),function(t){console.log("frame"),console.log(t)}),t.tx(I([2]))},500);else if("i2c"==this.type){this.transport.setup({bitrate:4e5}),this.on("drain",function(){t._read()});try{this.tx(1)}catch(t){console.log("Handled",t.msg),console.log("Continue...")}this.tx(I([2])),this.rx([].concat(w,_),{timeout:10},function(t){console.log("frame"),console.log(t)})}},read:function(t){if("i2c"==this.type)for(;this.transport.readFrom(36,1)[0];){var e=this.transport.readFrom(36,1+t);this.push(e)}else this.type},write:function(t){"serial"==this.type?this.transport.write(t):"i2c"==this.type&&this.transport.writeTo(36,t)},highWaterMark:16});H.on("error",function(t){console.error("BusError:",t)}),H.setup();
//# sourceMappingURL=index.esp32.min.js.map
