"use strict";function t(){throw Error()}function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,{_buffer:[],length:0},t)}function n(t){return t.currentPattern=null,t.arrayOffset=t.patternIndex=t.byteIndex=t.length=0,t.active=!1,t}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setup=t.setup.bind(this),this._read=t.read.bind(this),this._write=t.write.bind(this),this.options={highWaterMark:t.highWaterMark||T},this._busState=new e({watching:[],active:0,nodeIndex:0,configured:!1,ticker:!1})}if("function"!=typeof console.time){var i={};console.time=function(t){i[t]=Date.now()},console.timeEnd=function(t){t in i&&(console.log(t+": "+(Date.now()-i[t]).toFixed(3)+"ms"),delete i[t])}}"function"!=typeof console.error&&(console.error=console.log),[].concat=function(){var t=[];for(var e in this)t.push(this[e]);for(var n in arguments)for(var r in arguments[n])t.push(arguments[n][r]);return t},Promise.race=function(t){if(!(t instanceof Array))throw new TypeError("You must pass an array to Promise.race().");return new this(function(e,n){for(var r,i=0;i<t.length;i++)(r=t[i])&&"function"==typeof r.then?r.then(e,n):e(r)})};var u=1,c=0;"ESP32"==process.env.CHIP.toUpperCase()&&(u=0,c=1);var o=function(t,e,n){t.write(u),setTimeout(function(){t.write(c),n&&n()},e||20)},s=0,a=0,h=255,f=212,l=64,d=96,g=160,v=function(t){return!(255&-t.reduce(function(t,e){return t+e},0))},b=function(t,e,n){return v(n.slice(5))},m=[[s,a,h,void 0,function(t,e,n){return v(n.slice(-2))},213],function(t){return[[t[3]-1]]},[b,0]],p=[[s,a,h,1,255,void 0,b,0]],_=[new Uint8ClampedArray([s,a,h,0,255,0])],w=[new Uint8ClampedArray([s,a,h,255,0,0])],x=function(t){return new Uint8ClampedArray([s,a,h,255&t.length+1,255&~t.length,f].concat(t,[255&-t.reduce(function(t,e){return t+e},f),0]))};Object.assign=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i in n){var u=n[i];if(u instanceof Object)for(var c in u)t[c]=u[c]}return t},t.from=function(t,e,n){var r=[];if("string"==typeof t)for(var i in t)r[i]=t.charCodeAt(i);else(t instanceof Uint8Array||t instanceof Array)&&(r=t);var u=void 0!==e?e:0,c=void 0!==n?n:r.length;return new Uint8Array([].concat([].fill(0,0,u),[].slice.call(r,0),[].fill(0,r.length+u,c)))},t.concat=function(e,n){var r=e||[],i=void 0!==n?n:r.reduce(function(t,e){return t+e.length},0),u=t.from([],0,i);return r.reduce(function(t,e){return u.set(e,t),t+e.length},0),u};var k=[{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!1,tick:!1}],y=!1,S=function(){for(var t in k){if(k[t].queue.length)if(k[t].immediatePush){for(var e=0;e<k[t].queue.length;e++)k[t].queue[e]();k[t].queue.splice(0)}else for(var n=k[t].queue.splice(0),r=0;r<n.length;r++)n[r]();k[t].tick=y=!1}},I=function(t){return function(e){k[t].queue.push(e),y||k[t].tick||(k[t].tick=y=!0,setTimeout(S))}},P=(I(0),I(1));I(2),e.prototype={push:function(e){if(e.length){var n={chunk:t.from(e),encoding:"binary",next:null};this._buffer.length&&(this._buffer[this._buffer.length-1].next=n),this._buffer.push(n),this.length+=n.chunk.length}return this.length},unshift:function(e){var n={chunk:t.from(e),encoding:"binary",next:null};return this._buffer.length&&(n.next=this._buffer[0]),this._buffer.unshift(n),this.length+=n.chunk.length,this.length},nodes:function(t){var e=this,n=this._buffer.splice(0,t);return n.forEach(function(t){return e.length-=t.chunk.length}),n},at:function(t){if(!(t>=this.length||t<0))for(var e=0;e<this._buffer.length;e++){var n=this._buffer[e].chunk;if(t<n.length)return{index:t,nodeIndex:e,value:n[t]};t-=n.length}},for:function(t,e,n){for(var r=this._buffer[t.nodeIndex],i=t.nodeIndex;i<r.chunk.length;i++)n.call(this,r.chunk[i]);for(var u=1+t.nodeIndex;u<e.nodeIndex;u++)for(var c=this._buffer[u],o=0;o<c.chunk.length;o++)n.call(this,c.chunk[o]);if(t.nodeIndex<e.nodeIndex)for(var s=this._buffer[e.nodeIndex],a=0;a<=e.index;a++)n.call(this,s.chunk[a])},slice:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from([],0,e),i=this._buffer.slice(0,n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var u=this._buffer[n.nodeIndex];r.set(u.chunk.slice(0,e-i),i)}return r},buffer:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from([],0,e),i=this.nodes(n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var u=this.nodes(1)[0];r.set(u.chunk.slice(0,e-i),i),u.chunk=u.chunk.slice(e-i),this.unshift(u.chunk)}return r}};var T=64;r.prototype={setup:function(){return this._busState.configured?Promise.reject("already configured"):(this._busState.configured=!0,this._setup.apply(this,arguments))},parse:function(e){var r=this;this._busState.push(e),this._busState.ticker||(this._busState.ticker=!0,P(function(){r._busState.ticker=!1,function(){var e=this,r=this._busState,i=r.watching,u=(r.frame,r._buffer);if(i.length)for(this._busState.nodeIndex<0&&(this._busState.nodeIndex=0);this._busState.nodeIndex<u.length;this._busState.nodeIndex++)for(var c=u[this._busState.nodeIndex].chunk,o=currentIncomingWatcherIndex=watcherIndex=0,s=isChunkCorrupted=!1;o<c.length;o++){this._busState.active||(this._busState.active=this._busState.watching.reduce(function(n,r){var i=r.patterns;try{return r.currentPattern="function"==typeof i[0]?i[0](t.from([])):i[0],r.active=!0,n+1}catch(t){return e.emit("error",t),n}},0));var a=c[o];for(watcherIndex=0;watcherIndex<i.length;watcherIndex++,s=!1){var h=i[watcherIndex];if(h.active){var f=h.currentPattern[h.byteIndex];if(void 0===f||f===a)s=!0;else if(Array.isArray(f)){if(h.arrayOffset<=0&&f[0]>0&&(h.arrayOffset=f[0]),--h.arrayOffset>0){h.length++;continue}s=!0}else if("function"==typeof f)try{s=!!f.call(this,a,h.length,this._busState.slice(1+h.length))}catch(t){s=!1,this.emit("error",t)}if(s){if(h.length++,++h.byteIndex>=h.currentPattern.length)if(++h.patternIndex>=h.patterns.length){var l=this._busState.buffer(h.length);this._busState.nodeIndex=-1;try{h.callback(l,h.pattern)}catch(t){this.emit("error",t)}i.forEach(n),this._busState.active=0}else{var d=h.patterns[h.patternIndex];h.byteIndex=0;try{h.currentPattern="function"==typeof d?d.call(this,this._busState.slice(h.length)):d}catch(t){n(h),this._busState.active--,this.emit("error",t)}}}else n(h),this._busState.active--,!i.length&&this._busState.length&&this.emit("error",{msg:"Unparsed chunk",data:this._busState.buffer()})}}}else this.emit("error",{msg:"Unexpected watching data",data:this._busState.buffer()})}.call(r)}))},watch:function(t,e){var r=n({patterns:t,callback:e.bind(this)});return this._busState.watching.push(r),r},unwatch:function(t){if(t){var e=this._busState.watching.indexOf(t);e>=0&&this._busState.watching.splice(e,1)}else this._busState.watching.splice(0);return this},rx:function(t,e){var n=this.watch(t,e);return this._read(),n},tx:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"timeout"in n?setTimeout(function(){e._write(t)},n.timeout):this._write(t),this},reset:function(){return this._busState.watching.splice(0),this}};var A=function(e){return{raw:e,code:e[6],body:t.from(e.slice(7,5+e[3]))}},q=function(t){if(1==t.body.length)throw{cmd:t.code,errCode:t.body[0]};return{chunk:t.body.slice(1)}},C={makeTransaction:function(t,e,n){var r=this;return new Promise(function(i,u){r.rx(_,function(){r.rx(e,function(t){return i((n||[A]).reduce(function(t,e){return e(t)},t))})}),r.rx(w,u),r.rx(p,u),r.tx(x(t))}).catch(function(t){throw r.unwatch(),t}).then(function(t){return r.unwatch(),t})},findTargets:function(t,e){if("A"==e)e=0;else{if("B"!=e)throw Error("Unknown ISO14443 type:",e);e=3}return this.makeTransaction([74,t,e],m,[function(t){var e=t.slice(7,5+t[3]),n=e.slice(6,6+e[5]);return{code:t[6],body:e,count:e[0],atqa:e.slice(2,4),sak:e[4],uid:n}}])},authenticate:function(t,e,n){return this.makeTransaction([l,1,d,t].concat([].slice.call(n),[].slice.call(e)),m)},readBlock:function(t){return this.makeTransaction([l,1,48,t],m,[A,q])},writeBlock:function(t,e){return this.makeTransaction([l,1,g,t].concat([].slice.call(e)),m)},readSector:function(t){var e=this;return new Promise(function(n,r){for(var i=[],u=4*t;u<4*t+3;u++)i.push(u);!function(t,n,r){var u=0,c=!1;!function n(o){c||(void 0!==o||u>=t.length?r&&r(o):P(function(){try{!function(t,n,r){e.readBlock(n).then(function(e){i[r]=e,t()}).catch(function(e){console.log("!!!"),t(e)})}(n,t[u],u++)}catch(t){n(t),c=!0}}))}()}(i,0,function(t){return t?r(t):n(i)})})},writeSector:function(t,e){}},O=Serial1,U=D5,E=x([85]),j=x([20,1,20,0]),B=Serial2;O.setConsole(!0);var W=new function(t){return Object.assign(new r({setup:function(t){B.setup(115200),B.write(E),B.write(j),setTimeout(function(){B.read(),B.on("data",function(t){return W.parse(t)}),o(U,20,function(){return setTimeout(function(){return o(U,20)},200)})},50)},read:function(){},write:function(t){B.write(t)},highWaterMark:64}),C)}(0);W.on("error",function(t){console.error("BusError:",t)}),W.setup();var D=new Uint8Array([].fill(255,0,6));setTimeout(function(){!function t(){Promise.resolve().then(function(){return W.findTargets(1,"A")}).then(function(t){return U.write(!0),t}).then(function(t){return W.authenticate(4,t.uid,D)}).then(function(t){return W.readSector(1)}).then(function(t){return U.write(!1),t}).then(function(t){return t.reduce(function(t,e){return[].concat(t,[].slice.call(e.chunk,0))},[])}).then(console.log).catch(function(t){U.write(!1),console.error("Error:",t)}).then(function(){setTimeout(function(){t()},500)})}()},1e3);
//# sourceMappingURL=index.esp32.min.js.map
