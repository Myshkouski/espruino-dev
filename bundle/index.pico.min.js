"use strict";function t(){throw Error("Buffer proto is deprecated. Use Buffer.from() instead.")}function e(){this._listeners={}}function n(t){t&&("#"+t in this?this._listeners[t]=this["#"+t]:delete this._listeners[t])}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,{_buffer:[],length:0},t)}function i(t){return{chunk:j(t),encoding:"binary",next:null}}function o(t){return Object.assign(t,{active:!1,currentPattern:null,length:0,offset:0,byteIndex:0,patternIndex:0})}function c(){this._busState.active=0,this.emit("inactive")}function u(){--this._busState.active||this.emit("inactive")}function s(t){if(1+t.patternIndex<t.list.length){var e=t.list[++t.patternIndex];if(t.byteIndex=0,"function"==typeof e)try{t.currentPattern=e.call(this,this._busState.slice(1+t.length))}catch(e){o(t),u.call(this),this.emit("error",e)}else t.currentPattern=e}else(function(t){var e=this._busState,n=e.watching,r=e.buffer(t.length);e.nodeIndex=-1;try{t.callback(r,t)}catch(t){this.emit("error",t)}n.forEach(o),c.call(this)}).call(this,t)}function a(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.transport=e.transport,this.type=e.type,this._setup=e.setup.bind(this),this._read=function(n){return e.read.call(t,void 0===n?n:t.options.highWaterMark)},this._write=e.write.bind(this),this.options={highWaterMark:e.highWaterMark||B},this._busState=new r({watching:[],active:0,nodeIndex:0,configured:!1,ticker:!1})}function f(){}if("function"!=typeof console.time){var h={};console.time=function(t){h[t]=Date.now()},console.timeEnd=function(t){t in h&&(console.log(t+": "+(Date.now()-h[t]).toFixed(3)+"ms"),delete h[t])}}"function"!=typeof console.error&&(console.error=console.log),[].concat=function(){var t=[];for(var e in this)t.push(this[e]);for(var n in arguments)for(var r in arguments[n])t.push(arguments[n][r]);return t},Promise.race=function(t){if(!(t instanceof Array))throw new TypeError("You must pass an array to Promise.race().");return new this(function(e,n){for(var r,i=0;i<t.length;i++)(r=t[i])&&"function"==typeof r.then?r.then(e,n):e(r)})};var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};ArrayBuffer.isView=function(t){return"object"===(void 0===t?"undefined":l(t))&&t.buffer instanceof ArrayBuffer};var p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d=Uint8Array;t.isBuffer=function(t){return t instanceof d},t.from=function(t,e,n){if("string"==typeof t){var r=[];for(var i in t)r[i]=t.charCodeAt(i);return new d(r)}if(Array.isArray(t)||this.isBuffer(t))return new d(t);if(t instanceof ArrayBuffer)return e=void 0!==e?e:0,n=void 0!==n?n:t.byteLength,new d(t.slice(e,e+n));throw new TypeError("Cannot create buffer from",void 0===t?"undefined":p(t))},t.concat=function(t,e){var n=t||[],r=void 0!==e?e:n.reduce(function(t,e){return t+e.length},0),i=this.from([],0,r);return n.reduce(function(t,e){return i.set(e,t),t+e.length},0),i};var y=t;Object.assign=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i in n){var o=n[i];if(o instanceof Object)for(var c in o)t[c]=o[c]}return t};var v=Object.defineProperty;Object.defineProperty=function(t,e,n){try{return v(t,e,n)}catch(r){return n.get?t.value=n.get():n.value&&(t[e]=n.value),t}},Object.defineProperties=function(t,e){for(var n in e){var r=e[n];Object.defineProperty(t,n,r)}return t};var g=1,b=0;process.env.CHIP&&"ESP32"==process.env.CHIP.toUpperCase()&&(g=0,b=1);var m=function(t,e,n){t.write(g),setTimeout(function(){t.write(b),n&&n()},e||20)},w="_super",_="_apply",k="_isExtended",x=function(t,e,n,r){t.prototype[n]||Object.defineProperty(t.prototype,n,{value:[]}),e.forEach(function(e){var i=!!e.prototype[k],o=!!e.prototype[n],c=t.prototype[n].some(function(t){return t===e}),u=!(i&&r||c);i&&o&&e.prototype[n].forEach(function(e){t.prototype[n].some(function(t){return t===e})||t.prototype[n].push(e)}),u&&t.prototype[n].push(e)})},S=function(){function t(){var e=this,n=arguments;t.prototype[_].forEach(function(r){r!==t&&r.apply(e,n)})}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.apply||(e.apply=[]),e.proto||(e.proto=[]);var n=e.proto[0];e.name||(e.name=n.name),function(e,n){Object.defineProperty(t,"name",{value:e})}(e.name),Object.defineProperty(t,"prototype",{value:{}}),Object.defineProperty(t.prototype,"constructor",{value:n}),Object.defineProperty(t.prototype,k,{value:!0});for(var r in e.proto){var i=function(){};i.prototype=e.proto[r].prototype;var o=new i;for(var c in o)["constructor",k,w,_].indexOf(c)<0&&Object.defineProperty(t.prototype,c,{value:o[c],enumerable:!0,writable:!0})}return x(t,e.proto,w,!1),x(t,e.apply,_,!0),t},I=[{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!1,tick:!1}],P=!1,A=function(){for(var t in I){if(I[t].queue.length)if(I[t].immediatePush){for(var e=0;e<I[t].queue.length;e++)I[t].queue[e]();I[t].queue.splice(0)}else for(var n=I[t].queue.splice(0),r=0;r<n.length;r++)n[r]();I[t].tick=P=!1}},E=function(t){return function(e){I[t].queue.push(e),P||I[t].tick||(I[t].tick=P=!0,setTimeout(A))}},O=E(0);E(1),e.prototype={on:function(t,e){return{}.on.call(this,t,e),n.call(this,t),this},removeListener:function(t,e){return{}.on.call(this,t,e),n.call(this,t),this},once:function(t,e){return this.on(t,function(){return this.removeListener(t,_listener),e.apply(this,arguments)})}};var j=require("buffer-from");r.prototype={push:function(t){if(t.length){var e=i(t);this._buffer.length&&(this._buffer[this._buffer.length-1].next=e),this._buffer.push(e),this.length+=e.chunk.length}return this.length},unshift:function(t){var e=i(t);return this._buffer.length&&(e.next=this._buffer[0]),this._buffer.unshift(e),this.length+=e.chunk.length,this.length},nodes:function(t){var e=this,n=this._buffer.splice(0,t);return n.forEach(function(t){return e.length-=t.chunk.length}),n},at:function(t){if(!(t>=this.length||t<0))for(var e=0;e<this._buffer.length;e++){var n=this._buffer[e].chunk;if(t<n.length)return{index:t,nodeIndex:e,value:n[t]};t-=n.length}},for:function(t,e,n){for(var r=this._buffer[t.nodeIndex],i=t.nodeIndex;i<r.chunk.length;i++)n.call(this,r.chunk[i]);for(var o=1+t.nodeIndex;o<e.nodeIndex;o++)for(var c=this._buffer[o],u=0;u<c.chunk.length;u++)n.call(this,c.chunk[u]);if(t.nodeIndex<e.nodeIndex)for(var s=this._buffer[e.nodeIndex],a=0;a<=e.index;a++)n.call(this,s.chunk[a])},slice:function(t){if(void 0===t&&(t=this.length),!t)return j([]);t>this.length&&(t=this.length);var e=void 0;t&&(e=this.at(t)),e||(e={index:this.length-1,nodeIndex:this._buffer.length-1});var n=j(Array(t)),r=this._buffer.slice(e.nodeIndex-1).reduce(function(t,e){return n.set(e.chunk,t),t+e.chunk.length},0);if(r<t){var i=this._buffer[e.nodeIndex];n.set(i.chunk.slice(0,t-r),r)}return n},buffer:function(t){if(void 0===t&&(t=this.length),!t)return j([]);t>this.length&&(t=this.length);var e=void 0;t&&(e=this.at(t)),e||(e={index:this.length-1,nodeIndex:this._buffer.length-1});var n=j(Array(t)),r=this.nodes(e.nodeIndex).reduce(function(t,e){return n.set(e.chunk,t),t+e.chunk.length},0);if(r<t){var i=this.nodes(1)[0];n.set(i.chunk.slice(0,t-r),r),t-r<i.chunk.length&&(i.chunk=i.chunk.slice(t-r),this.unshift(i.chunk))}return n}};var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},B=64;a.prototype={setup:function(){return this._busState.configured?Promise.reject("already configured"):(this._busState.configured=!0,this._setup.apply(this,arguments))},push:function(t){var e=this;t.length&&(this._busState.push(t),this._busState.ticker||(this._busState.ticker=!0,O(function(){e._busState.ticker=!1,function(){for(var t=this,e=this._busState,n=e.watching,r=e._buffer;e.nodeIndex<r.length;e.nodeIndex++){if(!n.length)return void this.emit("error",{msg:"Unexpected incoming data",data:e.buffer()});e.nodeIndex<0&&(e.nodeIndex=0);var i=r[e.nodeIndex].chunk,c=0,a=0,f=!1;for(e.active||(e.active=e.watching.reduce(function(n,r){var i=r.list;try{return r.currentPattern="function"==typeof i[0]?i[0].call(t,e.slice(r.length)):i[0],r.active=!0,1+n}catch(e){return t.emit("error",e),n}},0));c<i.length;c++){var h=i[c];for(a=0;a<n.length;a++,f=!1){var l=n[a];if(l.active){var p=l.currentPattern;if(Array.isArray(p)||ArrayBuffer.isView(p)){var d=p[l.byteIndex];if(void 0===d||"number"==typeof d&&d===h)f=!0;else if("function"==typeof d)try{f=!!d.call(this,h,l.length-1,e.slice(1+l.length))}catch(t){this.emit("error",t)}f?(++l.length,1+l.byteIndex<p.length?++l.byteIndex:s.call(this,l)):(o(l),u.call(this),e.active||this.emit("error",{message:"Unparsed chunk",expected:d,actual:h,pattern:p,chunk:e.buffer(),index:c,value:h}))}else{if("number"!=typeof p)throw new TypeError("Cannot parse pattern of "+(void 0===p?"undefined":T(p))+" type");if(p<=0)throw Object.assign(new ReferenceError("Pattern length should be a positive integer"),{pattern:p});l.offset<=0&&(l.offset=p),l.length++,--l.offset<1&&s.call(this,l)}}}}}e.active&&this.emit("drain")}.call(e)})))},watch:function(t,e){var n=o({list:t,callback:e.bind(this)});return this._busState.watching.push(n),n},unwatch:function(t){if(t){var e=this._busState.watching.indexOf(t);e>=0&&(this._busState.watching[e].active&&(o(t),u.call(this)),this._busState.watching.splice(e,1))}else this._busState.watching.splice(0),c.call(this);return this},expect:function(t){for(var e=this,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=void 0;if("function"==typeof r[0])o=r[0];else{if("function"!=typeof r[1])throw new ReferenceError("Callback is not provided");o=r[1],Object.assign({},r[0])}var c=void 0;return c=e.watch(t,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];e.unwatch(c),o.apply(e,n)}),e._read(e.options.highWaterMark),c},send:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"timeout"in n?setTimeout(function(){e._write(t)},n.timeout):this._write(t),this},reset:function(){return this._busState.watching.splice(0),this}};var q=S({proto:[e,a],apply:[e,a]}),U=0,C=0,L=255,D=212,M=64,W=96,F=160,H=function(t){return!(255&-t.reduce(function(t,e){return t+e},0))},R=function(t,e,n){return H(n.slice(5))},V=[[U,C,L,void 0,function(t,e,n){return H(n.slice(-2))},213],function(t){return t[3]-1},[R,0]],K=[[U,C,L,1,255,void 0,R,0]],Y=[new Uint8Array([U,C,L,0,255,0])],z=[new Uint8Array([U,C,L,255,0,0])],G=function(t){return new Uint8Array([U,C,L,255&t.length+1,255&~t.length,D].concat(t,[255&-t.reduce(function(t,e){return t+e},D),0]))},J=function(t){return{raw:t,code:t[6],body:t.slice(7,5+t[3])}},N=function(t){if(1==t.body.length)throw{cmd:t.code,code:t.body[0]};return{chunk:t.body.slice(1)}};f.prototype={makeTransaction:function(t,e,n){var r=this;return new Promise(function(i,o){r.expect(Y,function(){r.expect(e,function(t){i((n||[J]).reduce(function(t,e){return e(t)},t))})}),r.expect(z,o),r.expect(K,o),r.send(G(t))}).catch(function(t){throw r.unwatch(),t}).then(function(t){return r.unwatch(),t})},findTargets:function(t,e){if("A"==e)e=0;else{if("B"!=e)throw Error("Unknown ISO14443 type:",'"'+e+'"');e=3}return this.makeTransaction([74,t,e],V,[function(t){var e=t.slice(7,5+t[3]),n=e.slice(6,6+e[5]);return{code:t[6],body:e,count:e[0],atqa:e.slice(2,4),sak:e[4],uid:n}}])},authenticate:function(t,e,n){return this.makeTransaction([M,1,W,t].concat([].slice.call(n),[].slice.call(e)),V)},readBlock:function(t){return this.makeTransaction([M,1,48,t],V,[J,N])},writeBlock:function(t,e){return this.makeTransaction([M,1,F,t].concat([].slice.call(e)),V)},readSector:function(t){var e=this;return new Promise(function(n,r){for(var i=[],o=4*t;o<4*t+3;o++)i.push(o);!function(t,n,r){var o=0,c=!1;!function n(u){c||(void 0!==u||o>=t.length?r&&r(u):O(function(){try{!function(t,n,r){e.readBlock(n).then(function(e){i[r]=e,t()}).catch(function(e){console.log("!!!"),t(e)})}(n,t[o],o++)}catch(t){n(t),c=!0}}))}()}(i,0,function(t){return t?r(t):n(i)})})},writeSector:function(t,e){}};var Q=new(S({proto:[q,f],apply:[q,f]}))({transport:Serial1,type:"serial",setup:function(){var t=this;if("serial"==this.type)this.transport.setup(115200),this.transport.on("data",function(e){console.log(y.from(e)),t.push(e)}),this.transport.write(85),console.log("configuring sam"),this.send(G([20,1,20,0])),this.expect(Y,function(){console.log("sam ACK")}),this.expect(V,function(){console.log("sam configured"),m(LED1,20,function(){setTimeout(function(){return m(LED1,20)},200)})});else if("i2c"==this.type){this.transport.setup({bitrate:4e5}),this.on("drain",function(){t._read()});try{this.send(1)}catch(t){console.log("Handled",t.msg),console.log("Continue...")}this.send(G([2])),this.expect([].concat(Y,V),{timeout:10},function(t){console.log("frame"),console.log(t)})}},read:function(t){if("i2c"==this.type)for(;this.transport.readFrom(36,1)[0];){var e=this.transport.readFrom(36,1+t);this.push(e)}else this.type},write:function(t){"serial"==this.type?this.transport.write(t):"i2c"==this.type&&this.transport.writeTo(36,t)},highWaterMark:16});Q.on("error",function(t){console.error("BusError:",t)}),Q.setup();var X=new Uint8Array(Array(6).fill(255));setTimeout(function(){Promise.resolve().then(function(){!function t(){console.log(process.memory().free),console.log(Q._busState.watching.length),Promise.resolve().then(function(){return Q.findTargets(2,"A")}).then(function(t){return console.log("found target",t),LED1.write(1),t}).then(function(t){return Q.authenticate(4,t.uid,X)}).then(function(t){console.log("auth",t)}).then(function(t){return console.log("reading",1,"sector"),t}).then(function(t){return Q.readSector(1)}).then(function(t){return console.log("after init",t),t}).catch(function(t){console.error("Error:",t)}).then(function(){LED1.write(0),LED2.write(0),Q.send.apply(Q,Y),Q.unwatch(),setTimeout(function(){t()},500)})}()}).catch(console.error)},1e3);
//# sourceMappingURL=index.pico.min.js.map
