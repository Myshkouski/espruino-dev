"use strict";function t(){throw Error()}function e(){this._listeners={}}function n(t){t&&("#"+t in this?this._listeners[t]=this["#"+t]:delete this._listeners[t])}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,{_buffer:[],length:0},t)}function i(t){return t.currentPattern=null,t.arrayOffset=t.patternIndex=t.byteIndex=t.index=0,t.active=!1,t}function o(){this._busState.active=0,this.emit("inactive")}function c(){--this._busState.active||this.emit("inactive")}function u(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.transport=e.transport,this.type=e.type,this._setup=e.setup.bind(this),this._read=function(n){return e.read.call(t,void 0===n?n:t.options.highWaterMark)},this._write=e.write.bind(this),this.options={highWaterMark:e.highWaterMark||P},this._busState=new r({watching:[],active:0,nodeIndex:0,configured:!1,ticker:!1})}function s(){}if("function"!=typeof console.time){var a={};console.time=function(t){a[t]=Date.now()},console.timeEnd=function(t){t in a&&(console.log(t+": "+(Date.now()-a[t]).toFixed(3)+"ms"),delete a[t])}}"function"!=typeof console.error&&(console.error=console.log);var f=1,h=0;process.env.CHIP&&"ESP32"==process.env.CHIP.toUpperCase()&&(f=0,h=1);var l=function(t,e,n){t.write(f),setTimeout(function(){t.write(h),n&&n()},e||20)};Object.assign=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i in n){var o=n[i];if(o instanceof Object)for(var c in o)t[c]=o[c]}return t};var p=Object.defineProperty;Object.defineProperty=function(t,e,n){try{return p(t,e,n)}catch(r){return desc.get?t.value=n.get():desc.value&&(t[e]=n.value),t}},Object.defineProperties=function(t,e){for(var n in e){var r=e[n];Object.defineProperty(t,n,r)}return t};var d="_super",v="_apply",y="_isExtended",g=function(t,e,n,r){t.prototype[n]||Object.defineProperty(t.prototype,n,{value:[]}),e.forEach(function(e){var i=!!e.prototype[y],o=!!e.prototype[n],c=t.prototype[n].some(function(t){return t===e}),u=!(i&&r||c);i&&o&&e.prototype[n].forEach(function(e){t.prototype[n].some(function(t){return t===e})||t.prototype[n].push(e)}),u&&t.prototype[n].push(e)})},b=function(){function t(){var e=this,n=arguments;t.prototype[v].forEach(function(r){r!==t&&r.apply(e,n)})}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.apply||(e.apply=[]),e.super||(e.super=[]),e.static||(e.static=[]);var n=e.super[0];e.name||(e.name=n.name),function(e,n){Object.defineProperty(t,"name",{value:e})}(e.name);for(var r in e.static)for(var i in e.static[r])"prototype"!=i&&Object.defineProperty(t,i,{value:proto[i],enumerable:!0,writable:!0});Object.defineProperty(t,"prototype",{value:{}}),Object.defineProperty(t.prototype,"constructor",{value:n}),Object.defineProperty(t.prototype,y,{value:!0});for(var o in e.super){var c=function(){};c.prototype=e.super[o].prototype;var u=new c;for(var s in u)["constructor",y,d,v].indexOf(s)<0&&Object.defineProperty(t.prototype,s,{value:u[s],enumerable:!0,writable:!0})}return g(t,e.super,d,!1),g(t,e.apply,v,!0),t};[].concat=function(){var t=[];for(var e in this)t.push(this[e]);for(var n in arguments)for(var r in arguments[n])t.push(arguments[n][r]);return t},Promise.race=function(t){if(!(t instanceof Array))throw new TypeError("You must pass an array to Promise.race().");return new this(function(e,n){for(var r,i=0;i<t.length;i++)(r=t[i])&&"function"==typeof r.then?r.then(e,n):e(r)})};var m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};t.from=function(t,e,n){if("string"==typeof t){var r=[];for(var i in t)r[i]=t.charCodeAt(i);return new Uint8Array(r)}if(t instanceof ArrayBuffer)return new Uint8Array(t.slice(void 0!==e?e:0,e+(void 0!==n?n:t.length)));if(t instanceof Array||t instanceof Uint8Array)return new Uint8Array(t);throw new TypeError("Cannot create buffer from",void 0===t?"undefined":m(t))},t.concat=function(e,n){var r=e||[],i=void 0!==n?n:r.reduce(function(t,e){return t+e.length},0),o=t.from([],0,i);return r.reduce(function(t,e){return o.set(e,t),t+e.length},0),o};var w=[{queue:[],immediatePush:!0,tick:!1},{queue:[],immediatePush:!1,tick:!1}],x=!1,k=function(){for(var t in w){if(w[t].queue.length)if(w[t].immediatePush){for(var e=0;e<w[t].queue.length;e++)w[t].queue[e]();w[t].queue.splice(0)}else for(var n=w[t].queue.splice(0),r=0;r<n.length;r++)n[r]();w[t].tick=x=!1}},_=function(t){return function(e){w[t].queue.push(e),x||w[t].tick||(w[t].tick=x=!0,setTimeout(k))}},I=_(0);_(1),e.prototype={on:function(t,e){return{}.on.call(this,t,e),n.call(this,t),this},removeListener:function(t,e){return{}.on.call(this,t,e),n.call(this,t),this},once:function(t,e){return this.on(t,function(){return this.removeListener(t,_listener),e.apply(this,arguments)})}},r.prototype={push:function(e){if(e.length){var n={chunk:t.from(e),encoding:"binary",next:null};this._buffer.length&&(this._buffer[this._buffer.length-1].next=n),this._buffer.push(n),this.length+=n.chunk.length}return this.length},unshift:function(e){var n={chunk:t.from(e),encoding:"binary",next:null};return this._buffer.length&&(n.next=this._buffer[0]),this._buffer.unshift(n),this.length+=n.chunk.length,this.length},nodes:function(t){var e=this,n=this._buffer.splice(0,t);return n.forEach(function(t){return e.length-=t.chunk.length}),n},at:function(t){if(!(t>=this.length||t<0))for(var e=0;e<this._buffer.length;e++){var n=this._buffer[e].chunk;if(t<n.length)return{index:t,nodeIndex:e,value:n[t]};t-=n.length}},for:function(t,e,n){for(var r=this._buffer[t.nodeIndex],i=t.nodeIndex;i<r.chunk.length;i++)n.call(this,r.chunk[i]);for(var o=1+t.nodeIndex;o<e.nodeIndex;o++)for(var c=this._buffer[o],u=0;u<c.chunk.length;u++)n.call(this,c.chunk[u]);if(t.nodeIndex<e.nodeIndex)for(var s=this._buffer[e.nodeIndex],a=0;a<=e.index;a++)n.call(this,s.chunk[a])},slice:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from(Array(e)),i=this._buffer.slice(0,n.nodeIndex-1).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var o=this._buffer[n.nodeIndex];r.set(o.chunk.slice(0,e-i),i)}return r},buffer:function(e){if(void 0===e&&(e=this.length),!e)return t.from([]);e>this.length&&(e=this.length);var n=void 0;e&&(n=this.at(e)),n||(n={index:this.length-1,nodeIndex:this._buffer.length-1});var r=t.from(Array(e)),i=this.nodes(n.nodeIndex).reduce(function(t,e){return r.set(e.chunk,t),t+e.chunk.length},0);if(i<e){var o=this.nodes(1)[0];r.set(o.chunk.slice(0,e-i),i),o.chunk=o.chunk.slice(e-i),this.unshift(o.chunk)}return r}};var P=64;u.prototype={setup:function(){return this._busState.configured?Promise.reject("already configured"):(this._busState.configured=!0,this._setup.apply(this,arguments))},push:function(t){var e=this;t.length&&(this._busState.push(t),this._busState.ticker||(this._busState.ticker=!0,I(function(){e._busState.ticker=!1,function(){for(var t=this,e=this._busState,n=e.watching,r=e._buffer;e.nodeIndex<r.length;e.nodeIndex++){if(!n.length)return void this.emit("error",{msg:"Unexpected incoming data",data:e.buffer()});e.nodeIndex<0&&(e.nodeIndex=0);for(var u=r[e.nodeIndex].chunk,s=0,a=0,f=!1;s<u.length;s++){e.active||(e.active=e.watching.reduce(function(n,r){var i=r.patterns;try{return r.currentPattern="function"==typeof i[0]?i[0](e.slice(r.length)):i[0],r.active=!0,1+n}catch(e){return t.emit("error",e),n}},0));var h=u[s];for(a=0;a<n.length;a++,f=!1){var l=n[a];if(l.active){var p=l.currentPattern;if(Array.isArray(p)){var d=p[l.byteIndex];if(void 0===d||"number"==typeof d&&d===h)f=!0;else if("function"==typeof d)try{f=!!d.call(this,h,l.index,e.slice(l.index))}catch(t){this.emit("error",t)}}else if("number"==typeof p){if(p<=0)throw new RangeError("Pattern length should be a positive integer, but set to",p);if(l.arrayOffset<=0&&(l.arrayOffset=p),console.log(--l.arrayOffset),--l.arrayOffset>0){l.index++;continue}f=!0}if(f){if(l.index++,++l.byteIndex>=p.length)if(++l.patternIndex>=l.patterns.length){var v=e.buffer(l.index);e.nodeIndex=-1;try{l.callback(v,l.pattern)}catch(t){this.emit("error",t)}n.forEach(i),o.call(this)}else{var y=l.patterns[l.patternIndex];if(l.byteIndex=0,"function"==typeof y)try{l.currentPattern=y.call(this,e.slice(l.length))}catch(t){i(l),c.call(this),this.emit("error",t)}else l.currentPattern=y}}else i(l),c.call(this),e.active||this.emit("error",{msg:"Unparsed chunk",data:e.buffer()})}}}}e.active&&this.emit("drain")}.call(e)})))},watch:function(t,e){var n=i({patterns:t,callback:e.bind(this)});return this._busState.watching.push(n),n},unwatch:function(t){if(t){var e=this._busState.watching.indexOf(t);e>=0&&(this._busState.watching[e].active&&(i(t),c.call(this)),this._busState.watching.splice(e,1))}else this._busState.watching.splice(0),o.call(this);return this},expect:function(t){for(var e=this,n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=void 0;if("function"==typeof r[0])o=r[0];else{if("function"!=typeof r[1])throw new ReferenceError("Callback is not provided");o=r[1],Object.assign({},r[0])}var c=void 0;return c=e.watch(t,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];e.unwatch(c),o.apply(e,n)}),e._read(e.options.highWaterMark),c},send:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"timeout"in n?setTimeout(function(){e._write(t)},n.timeout):this._write(t),this},reset:function(){return this._busState.watching.splice(0),this}};var S=b({super:[e,u],apply:[e,u]}),O=0,A=0,E=255,j=212,T=64,U=96,q=160,C=function(t){return!(255&-t.reduce(function(t,e){return t+e},0))},B=function(t,e,n){return C(n.slice(5))},M=[[O,A,E,void 0,function(t,e,n){return C(n.slice(-2))},213],function(t){return t[3]-1},[B,0]],W=[[O,A,E,1,255,void 0,B,0]],D=[new Uint8Array([O,A,E,0,255,0])],L=[new Uint8Array([O,A,E,255,0,0])],F=function(t){return new Uint8Array([O,A,E,255&t.length+1,255&~t.length,j].concat(t,[255&-t.reduce(function(t,e){return t+e},j),0]))},H=function(e){return{raw:e,code:e[6],body:t.from(e.slice(7,5+e[3]))}},R=function(t){if(1==t.body.length)throw{cmd:t.code,errCode:t.body[0]};return{chunk:t.body.slice(1)}};s.prototype={makeTransaction:function(t,e,n){var r=this;return new Promise(function(i,o){r.expect(D,function(){r.expect(e,function(t){return i((n||[H]).reduce(function(t,e){return e(t)},t))})}),r.expect(L,o),r.expect(W,o),r.send(F(t))}).catch(function(t){throw r.unwatch(),t}).then(function(t){return r.unwatch(),t})},findTargets:function(t,e){if("A"==e)e=0;else{if("B"!=e)throw Error("Unknown ISO14443 type:",'"'+e+'"');e=3}return this.makeTransaction([74,t,e],M,[function(t){var e=t.slice(7,5+t[3]),n=e.slice(6,6+e[5]);return{code:t[6],body:e,count:e[0],atqa:e.slice(2,4),sak:e[4],uid:n}}])},authenticate:function(t,e,n){return this.makeTransaction([T,1,U,t].concat([].slice.call(n),[].slice.call(e)),M)},readBlock:function(t){return this.makeTransaction([T,1,48,t],M,[H,R])},writeBlock:function(t,e){return this.makeTransaction([T,1,q,t].concat([].slice.call(e)),M)},readSector:function(t){var e=this;return new Promise(function(n,r){for(var i=[],o=4*t;o<4*t+3;o++)i.push(o);!function(t,n,r){var o=0,c=!1;!function n(u){c||(void 0!==u||o>=t.length?r&&r(u):I(function(){try{!function(t,n,r){e.readBlock(n).then(function(e){i[r]=e,t()}).catch(function(e){console.log("!!!"),t(e)})}(n,t[o],o++)}catch(t){n(t),c=!0}}))}()}(i,0,function(t){return t?r(t):n(i)})})},writeSector:function(t,e){}};var Y=b({super:[S,s],apply:[S,s]}),z=F([85]),G=F([20,1,20,0]),J=new Y({transport:Serial1,type:"serial",setup:function(){var t=this;if("serial"==this.type)this.transport.setup(115200),this.transport.write(z),this.transport.write(G),setTimeout(function(){t.transport.read(),t.transport.on("data",function(e){return t.push(e)}),console.log("Bus has been set up"),l(LED1,20,function(){setTimeout(function(){return l(LED1,20)},200)}),t.rx([].concat(D,M),function(t){console.log("frame"),console.log(t)}),t.tx(F([2]))},500);else if("i2c"==this.type){this.transport.setup({bitrate:4e5}),this.on("drain",function(){t._read()});try{this.tx(1)}catch(t){console.log("Handled",t.msg),console.log("Continue...")}this.tx(F([2])),this.rx([].concat(D,M),{timeout:10},function(t){console.log("frame"),console.log(t)})}},read:function(t){if("i2c"==this.type)for(;this.transport.readFrom(36,1)[0];){var e=this.transport.readFrom(36,1+t);this.push(e)}else this.type},write:function(t){"serial"==this.type?this.transport.write(t):"i2c"==this.type&&this.transport.writeTo(36,t)},highWaterMark:16});J.on("error",function(t){console.error("BusError:",t)}),J.setup();
//# sourceMappingURL=index.pico.min.js.map
